<html xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">


<head>
    <meta charset="UTF-8" />
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
    <link rel="stylesheet" href="../../static/css/me.css" />
    <title>Video</title>
</head>

<body>
    <!--导航-->
    <nav class="ui inverted m-shadow-small">
        <div class="ui container">
            <div class="ui secondary menu m-padded-tb-mini">
                <div class="item">
                    <img src="../../static/images/logo.png" th:src="@{/images/logo.png}"
                        class="ui rounded image head" />
                </div>
                <a href="#" th:href="@{/}" class="m-item item m-mobile-hide">主站</a>
                <a href="#" th:each="type:${session.types}!=null?${session.types}" th:text="${type.name}"
                    th:href="@{/type/{id}(id=${type.id})}" class="m-item item m-mobile-hide">类目1</a>
                <form class="right m-item item m-mobile-hide" name="search" action="#" th:action="@{/search}"
                    method="post" target="_blank">
                    <div class="ui icon transparent input m-margin-tb-tiny">
                        <input type="text" name="query" placeholder="输入搜索标题……" th:value="${query}">
                        <i onclick="document.forms['search'].submit()" class="search link icon"></i>
                    </div>
                </form>
                <div class="m-item item m-mobile-hide">
                    <img src="../../static/images/logo.png"
                        th:src="@{${session.user}!=null?${session.user.avatar}:'/images/logo.png'}"
                        class="ui rounded head-big" />
                </div>
                <a href="#" th:href="@{/login}" class="m-item item m-mobile-hide" th:if="${session.user}==null">登录</a>
                <a href="#" class="m-item item m-mobile-hide" th:if="${session.user}==null">注册</a>
                <a href="#" th:href="@{/tags/-1}" class="m-item item m-mobile-hide" th:if="${session.user}!=null">收藏</a>
                <a href="#" th:href="@{/tags/-1}" class="m-item item m-mobile-hide" th:if="${session.user}!=null">历史</a>
                <a href="#" th:href="@{/logout}" class="m-item item m-mobile-hide" th:if="${session.user}!=null">退出</a>
                <a href="#" th:href="@{/user/upload}" class="m-item item m-mobile-hide">投稿</a>
            </div>
        </div>
    </nav>
    <div class="ui m-margin-top-large container">
        <div class="ui m-margin-top column grid container">
            <div class="eight wide column">
                <form class="ui form" id="file" method="post" action="#" enctype="multipart/form-data">
                    <div class="field">
                        <label>视频选择</label>
                        <input type="file" name="video" id="filevideo" onchange="changepic(this)" multiple
                            placeholder="视频描述">
                    </div>
                    <div class="field">
                        <label>视频预览</label>
                        <video width='500' height='300' id='video' controls></video>
                    </div>
                    <div class="field">
                        <label>封面预览(拖动视频预览找到合适的封面，点击上传按钮)</label>
                        <canvas id="myCanvas" width="200" height="100"></canvas>
                    </div>
                    <button class="ui button" id="uploadvideo">上传视频</button>
                    <button class="ui button" id="uploadpic">上传封面</button>
                </form>
            </div>
            <div class="eight wide column">
                <form class="ui form" method="post" action="#" th:action="@{/user/addvideo}"
                    enctype="multipart/form-data">
                    <div class="field">
                        <label>标题</label>
                        <input name="title" type="text" placeholder="视频标题">
                    </div>
                    <div class="field">
                        <label>视频链接</label>
                        <input name="videoUrl" id="videoUrl" type="text" placeholder="视频链接" readonly>
                    </div>
                    <div class="field">
                        <label>视频描述</label>
                        <textarea name="description" type="text" placeholder="视频描述">
                        </textarea>
                    </div>
                    <div class="field">
                        <label>种类</label>
                        <select class="ui fluid search dropdown" name="typeId" id="dropdown">
                            <option value="1">动画</option>
                            <option value="2">游戏</option>
                            <option value="3">番剧</option>
                            <option value="4">教育</option>
                        </select>
                    </div>
                    <!--                    <div class="field">
                            <label>标签</label>
                            <select class="ui fluid search dropdown" multiple="">
                                <option value="1">动画</option>
                                <option value="2">游戏</option>
                                <option value="3">番剧</option>
                                <option value="4">教育</option>
                            </select>
                        </div>-->
                    <div class="field">
                        <label>封面链接</label>
                        <input name="pictureUrl" id="pictureUrl" type="text" placeholder="封面图片" readonly>
                    </div>
                    <button class="ui button" type="submit">提交</button>
                </form>
            </div>
        </div>
    </div>
    <script>
        $('.dropdown')
            .dropdown({
                maxSelections: 3
            });
        function dataURItoBlob(dataURI) {
            var byteString = atob(dataURI.split(',')[1]);
            var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
            var ab = new ArrayBuffer(byteString.length);
            var ia = new Uint8Array(ab);
            for (var i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: mimeString });
        }

        var imgHeight = 0,
            imgWidth = 0,
            videoWidth = 0,
            videoHeight = 0, pic;

        function getObjectURL(file) {
            var url = null;
            // 下面函数执行的效果是一样的，只是需要针对不同的浏览器执行不同的 js 函数而已
            if (window.createObjectURL != undefined) { // basic
                url = window.createObjectURL(file);
            } else if (window.URL != undefined) { // mozilla(firefox)
                url = window.URL.createObjectURL(file);
            } else if (window.webkitURL != undefined) { // webkit or chrome
                url = window.webkitURL.createObjectURL(file);
            }
            return url;
        }

        function changepic(obj) {
            //console.log(obj.files[0]);//这里可以获取上传文件的name
            // 转换格式
            var newsrc = getObjectURL(obj.files[0]);
            console.log(newsrc);
            //$('#video').src = newsrc;,这种方法不能实现
            document.getElementById('video').src = newsrc;
            console.log("123");
        }

        function dataURLtoFile(dataurl, filename) {
            console.log("转文件");
            var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], filename, { type: mime });
        }

        $('#uploadvideo').click(function () {
            var datatemp = new FormData($('#file')[0]);
            $.ajax({
                url: '/user/uploadvideo',
                type: 'post',
                processData: false,
                contentType: false,
                data: datatemp,
                success: function (data) {
                    alert("视频上传成功");
                    document.getElementById("videoUrl").value = data;
                }
            });
            return false;
        });

        $('#uploadpic').click(function () {
            var datatemp = new FormData();
            var imgFile = dataURLtoFile(pic, "img.png");
            datatemp.append("pic", imgFile);
            console.log(datatemp);
            $.ajax({
                url: '/user/uploadpic',
                type: 'post',
                processData: false,
                contentType: false,
                data: datatemp,
                success: function (data) {
                    alert("封面上传成功");
                    document.getElementById("pictureUrl").value = data;
                }
            });
            return false;
        });

        video = document.getElementById('video');
        canvas = document.getElementById("myCanvas");
        canvasCtx = canvas.getContext("2d");

        //视频准备好可以播放
        video.addEventListener("canplay", function () {
            //获取展示的video宽高作为画布的宽高和临时视频截图的宽高
            canvas.width = imgWidth = video.offsetWidth;
            canvas.height = imgHeight = video.offsetHeight;
            //获取实际视频的宽高，相当于视频分辨率吧
            videoWidth = video.videoWidth;
            videoHeight = video.videoHeight;
            setTimeout(() => {
                video.pause();
                //坐原图像的x,y轴坐标，大小，目标图像的x，y轴标，大小。
                canvasCtx.drawImage(video, 0, 0, videoWidth, videoHeight, 0, 0, imgWidth, imgHeight);
                //把图标base64编码后变成一段url字符串
                var dataUrl = canvas.toDataURL("image/png");
                // 获取图片的base64格式
                pic = dataUrl;
                document.getElementById("pictureUrl").value = '123';
            }, 500);
        });
    </script>
</body>

</html>